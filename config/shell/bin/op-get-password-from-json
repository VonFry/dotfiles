#!/usr/bin/env ruby

require 'json'

begin
  item = `op get item #{ARGV * " "}`
  op = JSON.parse(item)
rescue
  abort "JSON parse failed."
end

if op["details"]["fields"]
    username, password =
        op["details"]["fields"].select do |obj|
            obj["designation"].eql? "username"
        end + op["details"]["fields"].select do |obj|
            obj["designation"].eql? "password"
        end
    username = username["value"]
    password = password["value"]
elsif op["details"]["password"]
  username = nil
  password = op["details"]["password"]
end

puts <<EOF
uuid:      #{op["uuid"]}
vaultUuid: #{op["vaultUuid"]}
url:       #{op["overview"]["url"]}
title:     #{op["overview"]["title"]}
username:  #{username}
password:  #{password}
EOF

def check_command?(command)
  system "which #{command} > /dev/null 2>&1"

if check_command? "xclip"
    clip = "xclip -sel clip -i"
elsif check_command? "pbcopy"
    clip = "pbcopy"
else
    clip = nil
end

if clip
    `echo "#{username}" | #{clip}`
    print "copy username to clipboard..(any key continue)"
    gets

    `echo "#{password}" | #{clip}`
    print "copy password to clipboard..(any key continue)"
    gets

    `echo "" | #{clip}`
    print "clean clipboard.."
end

